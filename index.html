<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Stars Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        /* Custom styles */
        .tg-theme-bg {
            background-color: var(--tg-theme-bg-color, #ffffff);
        }
        .tg-theme-text {
            color: var(--tg-theme-text-color, #000000);
        }
        .tg-theme-hint {
            color: var(--tg-theme-hint-color, #707579);
        }
        .tg-theme-link {
            color: var(--tg-theme-link-color, #3390ec);
        }
        .tg-theme-button {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .tg-theme-secondary-bg {
            background-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .qr-code-container {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(51, 144, 236, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(51, 144, 236, 0); }
            100% { box-shadow: 0 0 0 0 rgba(51, 144, 236, 0); }
        }
        .success-checkmark {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            position: relative;
        }
        .success-checkmark .check-icon {
            width: 80px;
            height: 80px;
            position: relative;
            border-radius: 50%;
            box-sizing: content-box;
            border: 4px solid #4CAF50;
        }
        .success-checkmark .check-icon::before {
            top: 3px;
            left: -2px;
            width: 30px;
            transform-origin: 100% 50%;
            border-radius: 100px 0 0 100px;
        }
        .success-checkmark .check-icon::after {
            top: 0;
            left: 30px;
            width: 60px;
            transform-origin: 0 50%;
            border-radius: 0 100px 100px 0;
            animation: rotate-circle 4.25s ease-in;
        }
        .success-checkmark .check-icon::before, .success-checkmark .check-icon::after {
            content: '';
            height: 100px;
            position: absolute;
            background: transparent;
            transform: rotate(-45deg);
        }
        .success-checkmark .check-icon .icon-line {
            height: 5px;
            background-color: #4CAF50;
            display: block;
            border-radius: 2px;
            position: absolute;
            z-index: 10;
        }
        .success-checkmark .check-icon .icon-line.line-tip {
            top: 46px;
            left: 14px;
            width: 25px;
            transform: rotate(45deg);
            animation: icon-line-tip 0.75s;
        }
        .success-checkmark .check-icon .icon-line.line-long {
            top: 38px;
            right: 8px;
            width: 47px;
            transform: rotate(-45deg);
            animation: icon-line-long 0.75s;
        }
        @keyframes icon-line-tip {
            0% { width: 0; left: 1px; top: 19px; }
            54% { width: 0; left: 1px; top: 19px; }
            70% { width: 50px; left: -8px; top: 37px; }
            84% { width: 17px; left: 21px; top: 48px; }
            100% { width: 25px; left: 14px; top: 45px; }
        }
        @keyframes icon-line-long {
            0% { width: 0; right: 46px; top: 54px; }
            65% { width: 0; right: 46px; top: 54px; }
            84% { width: 55px; right: 0px; top: 35px; }
            100% { width: 47px; right: 8px; top: 38px; }
        }
    </style>
</head>
<body class="tg-theme-bg tg-theme-text min-h-screen">
    <div id="app" class="container mx-auto px-4 py-6 max-w-md">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-2xl font-bold mb-2">üåü Telegram Stars Shop</h1>
            <p class="tg-theme-hint">–ö—É–ø–∏—Ç–µ Telegram Stars –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ</p>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Main Menu -->
            <div id="main-menu" class="fade-in">
                <div class="bg-white/10 rounded-xl p-6 mb-6">
                    <h2 class="text-lg font-semibold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</h2>
                    <div class="space-y-3">
                        <button onclick="showBuySection('self')" class="w-full tg-theme-button py-3 px-4 rounded-lg flex items-center justify-between">
                            <span>–ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã —Å–µ–±–µ</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button onclick="showBuySection('friend')" class="w-full tg-theme-button py-3 px-4 rounded-lg flex items-center justify-between">
                            <span>–ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã –¥—Ä—É–≥—É</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v1h8v-1zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-1a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v1h-3zM4.75 12.094A5.973 5.973 0 004 15v1H1v-1a3 3 0 013.75-2.906z" />
                            </svg>
                        </button>
                        <button id="admin-btn" onclick="showAdminPanel()" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg flex items-center justify-between hidden">
                            <span>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="bg-white/10 rounded-xl p-6">
                    <h2 class="text-lg font-semibold mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                    <ul class="space-y-2 tg-theme-hint text-sm">
                        <li class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mt-0.5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <span>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞: <span class="font-medium tg-theme-text">50 –∑–≤—ë–∑–¥</span></span>
                        </li>
                        <li class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mt-0.5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <span>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞: <span class="font-medium tg-theme-text">25,000 –∑–≤—ë–∑–¥</span></span>
                        </li>
                        <li class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mt-0.5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <span>–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑: <span class="font-medium tg-theme-text">TON (Tonkeeper)</span></span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Buy for Self Section -->
            <div id="buy-self-section" class="hidden fade-in">
                <div class="bg-white/10 rounded-xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">–ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã —Å–µ–±–µ</h2>
                        <button onclick="backToMain()" class="text-sm tg-theme-link flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                            </svg>
                            –ù–∞–∑–∞–¥
                        </button>
                    </div>

                    <div id="self-username-section">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">–í–∞—à Telegram username</label>
                            <div class="relative">
                                <input type="text" id="self-username" class="w-full bg-white/5 border border-white/10 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="@username" readonly>
                                <button onclick="insertSelfUsername()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-sm tg-theme-link flex items-center">
                                    –í—Å—Ç–∞–≤–∏—Ç—å –º–æ–π username
                                </button>
                            </div>
                            <p class="text-xs tg-theme-hint mt-1">–ú—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ –≤–∞—à username</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ (50-25,000)</label>
                        <input type="number" id="self-stars-amount" class="w-full bg-white/5 border border-white/10 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="50" max="25000">
                    </div>

                    <button onclick="calculateSelfPrice()" class="w-full tg-theme-button py-3 px-4 rounded-lg">
                        –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å
                    </button>
                </div>

                <div id="self-price-result" class="hidden bg-white/10 rounded-xl p-6 mb-6">
                    <h2 class="text-lg font-semibold mb-4">–î–µ—Ç–∞–ª–∏ –ø–æ–∫—É–ø–∫–∏</h2>

                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between">
                            <span class="tg-theme-hint">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                            <span id="self-recipient" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="tg-theme-hint">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥:</span>
                            <span id="self-stars-count" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="tg-theme-hint">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–≤—ë–∑–¥:</span>
                            <span id="self-stars-price" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="tg-theme-hint">–ù–∞—Ü–µ–Ω–∫–∞ (20%):</span>
                            <span id="self-markup" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between text-lg pt-2 border-t border-white/10">
                            <span class="tg-theme-hint">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                            <span id="self-total-price" class="font-bold"></span>
                        </div>
                    </div>

                    <button onclick="proceedToPayment('self')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg mb-4">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
                    </button>

                    <button onclick="backToSelfForm()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg">
                        –ù–∞–∑–∞–¥
                    </button>
                </div>

                <div id="self-payment-section" class="hidden bg-white/10 rounded-xl p-6">
                    <h2 class="text-lg font-semibold mb-4">–û–ø–ª–∞—Ç–∞ TON</h2>

                    <div class="qr-code-container mb-4">
                        <canvas id="self-qr-code"></canvas>
                    </div>

                    <div class="bg-black/20 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm tg-theme-hint">–°—É–º–º–∞:</span>
                            <span id="self-payment-amount" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm tg-theme-hint">–ê–¥—Ä–µ—Å:</span>
                            <span id="self-payment-address" class="text-xs font-mono break-all text-right"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm tg-theme-hint">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</span>
                            <span id="self-payment-memo" class="text-xs font-mono break-all text-right"></span>
                        </div>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="copyPaymentDetails('self')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-3 rounded-lg text-sm flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                            </svg>
                            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <a id="self-tonkeeper-link" href="#" class="flex-1 tg-theme-button py-2 px-3 rounded-lg text-sm flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                            </svg>
                            Tonkeeper
                        </a>
                    </div>

                    <div class="mt-6 p-4 bg-yellow-500/10 rounded-lg border border-yellow-500/20">
                        <h3 class="text-sm font-semibold text-yellow-500 mb-1">–í–∞–∂–Ω–æ!</h3>
                        <p class="text-xs tg-theme-hint">1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å</p>
                        <p class="text-xs tg-theme-hint">2. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–ª–∞—Ç–µ–∂—É</p>
                        <p class="text-xs tg-theme-hint">3. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å—á—ë—Ç–∞: 10 –º–∏–Ω—É—Ç</p>
                    </div>

                    <div id="self-payment-status" class="mt-6">
                        <div id="self-payment-waiting" class="flex items-center justify-center p-4 border border-blue-500/20 rounded-lg bg-blue-500/10">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500 mr-2"></div>
                            <span class="text-sm">–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...</span>
                        </div>
                        <div id="self-payment-success" class="hidden flex-col items-center justify-center p-4 border border-green-500/20 rounded-lg bg-green-500/10">
                            <div class="success-checkmark mb-2">
                                <div class="check-icon">
                                    <span class="icon-line line-tip"></span>
                                    <span class="icon-line line-long"></span>
                                </div>
                            </div>
                            <span class="text-sm text-center">–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!<br>–ó–≤—ë–∑–¥—ã –±—É–¥—É—Ç –∑–∞—á–∏—Å–ª–µ–Ω—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.</span>
                        </div>
                        <div id="self-payment-failed" class="hidden flex items-center justify-center p-4 border border-red-500/20 rounded-lg bg-red-500/10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm">–û–ø–ª–∞—Ç–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞</span>
                        </div>
                    </div>

                    <button onclick="backToSelfPrice()" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg text-sm">
                        –ù–∞–∑–∞–¥
                    </button>
                </div>
            </div>

            <!-- Buy for Friend Section -->
            <div id="buy-friend-section" class="hidden fade-in">
                <div class="bg-white/10 rounded-xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">–ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã –¥—Ä—É–≥—É</h2>
                        <button onclick="backToMain()" class="text-sm tg-theme-link flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                            </svg>
                            –ù–∞–∑–∞–¥
                        </button>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Username –¥—Ä—É–≥–∞</label>
                        <input type="text" id="friend-username" class="w-full bg-white/5 border border-white/10 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="@username">
                        <p class="text-xs tg-theme-hint mt-1">–í–≤–µ–¥–∏—Ç–µ Telegram username –≤ —Ñ–æ—Ä–º–∞—Ç–µ @username</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ (50-25,000)</label>
                        <input type="number" id="friend-stars-amount" class="w-full bg-white/5 border border-white/10 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="50" max="25000">
                    </div>

                    <button onclick="calculateFriendPrice()" class="w-full tg-theme-button py-3 px-4 rounded-lg">
                        –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å
                    </button>
                </div>

                <div id="friend-price-result" class="hidden bg-white/10 rounded-xl p-6 mb-6">
                    <h2 class="text-lg font-semibold mb-4">–î–µ—Ç–∞–ª–∏ –ø–æ–∫—É–ø–∫–∏</h2>

                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between">
                            <span class="tg-theme-hint">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                            <span id="friend-recipient" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="tg-theme-hint">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥:</span>
                            <span id="friend-stars-count" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="tg-theme-hint">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–≤—ë–∑–¥:</span>
                            <span id="friend-stars-price" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="tg-theme-hint">–ù–∞—Ü–µ–Ω–∫–∞ (20%):</span>
                            <span id="friend-markup" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between text-lg pt-2 border-t border-white/10">
                            <span class="tg-theme-hint">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                            <span id="friend-total-price" class="font-bold"></span>
                        </div>
                    </div>

                    <button onclick="proceedToPayment('friend')" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg mb-4">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
                    </button>

                    <button onclick="backToFriendForm()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg">
                        –ù–∞–∑–∞–¥
                    </button>
                </div>

                <div id="friend-payment-section" class="hidden bg-white/10 rounded-xl p-6">
                    <h2 class="text-lg font-semibold mb-4">–û–ø–ª–∞—Ç–∞ TON</h2>

                    <div class="qr-code-container mb-4">
                        <canvas id="friend-qr-code"></canvas>
                    </div>

                    <div class="bg-black/20 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm tg-theme-hint">–°—É–º–º–∞:</span>
                            <span id="friend-payment-amount" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm tg-theme-hint">–ê–¥—Ä–µ—Å:</span>
                            <span id="friend-payment-address" class="text-xs font-mono break-all text-right"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm tg-theme-hint">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</span>
                            <span id="friend-payment-memo" class="text-xs font-mono break-all text-right"></span>
                        </div>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="copyPaymentDetails('friend')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-3 rounded-lg text-sm flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                            </svg>
                            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <a id="friend-tonkeeper-link" href="#" class="flex-1 tg-theme-button py-2 px-3 rounded-lg text-sm flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                            </svg>
                            Tonkeeper
                        </a>
                    </div>

                    <div class="mt-6 p-4 bg-yellow-500/10 rounded-lg border border-yellow-500/20">
                        <h3 class="text-sm font-semibold text-yellow-500 mb-1">–í–∞–∂–Ω–æ!</h3>
                        <p class="text-xs tg-theme-hint">1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å</p>
                        <p class="text-xs tg-theme-hint">2. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–ª–∞—Ç–µ–∂—É</p>
                        <p class="text-xs tg-theme-hint">3. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å—á—ë—Ç–∞: 10 –º–∏–Ω—É—Ç</p>
                    </div>

                    <div id="friend-payment-status" class="mt-6">
                        <div id="friend-payment-waiting" class="flex items-center justify-center p-4 border border-blue-500/20 rounded-lg bg-blue-500/10">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500 mr-2"></div>
                            <span class="text-sm">–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...</span>
                        </div>
                        <div id="friend-payment-success" class="hidden flex-col items-center justify-center p-4 border border-green-500/20 rounded-lg bg-green-500/10">
                            <div class="success-checkmark mb-2">
                                <div class="check-icon">
                                    <span class="icon-line line-tip"></span>
                                    <span class="icon-line line-long"></span>
                                </div>
                            </div>
                            <span class="text-sm text-center">–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!<br>–ó–≤—ë–∑–¥—ã –±—É–¥—É—Ç –∑–∞—á–∏—Å–ª–µ–Ω—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.</span>
                        </div>
                        <div id="friend-payment-failed" class="hidden flex items-center justify-center p-4 border border-red-500/20 rounded-lg bg-red-500/10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm">–û–ø–ª–∞—Ç–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞</span>
                        </div>
                    </div>

                    <button onclick="backToFriendPrice()" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg text-sm">
                        –ù–∞–∑–∞–¥
                    </button>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="admin-panel" class="hidden fade-in">
                <div class="bg-white/10 rounded-xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                        <button onclick="backToMain()" class="text-sm tg-theme-link flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                            </svg>
                            –ù–∞–∑–∞–¥
                        </button>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="tg-theme-hint">–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—Ü–µ–Ω–∫–∏:</span>
                            <span id="current-markup" class="font-bold text-lg">20%</span>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm font-medium mb-1">–ù–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—Ü–µ–Ω–∫–∏</label>
                            <input type="number" id="new-markup" class="w-full bg-white/5 border border-white/10 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç" min="0" max="100">
                        </div>
                    </div>

                    <button onclick="updateMarkup()" class="w-full tg-theme-button py-3 px-4 rounded-lg mb-4">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>

                    <div id="admin-message" class="hidden p-3 rounded-lg text-sm text-center"></div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-8 text-center text-xs tg-theme-hint">
            <p>Telegram Stars Shop ¬© 2023</p>
            <p class="mt-1">–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –±–ª–æ–∫—á–µ–π–Ω TON</p>
        </footer>
    </div>

    <script>
        // Telegram WebApp initialization
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // API Keys and configuration
        const TONAPI_KEY = "AF3JU5ZTHDFRVDQAAAANCVQIXVSTVCQI3D7TQUOTFKTYT7RJV5G3YPZ5HAAXZRQFJF7ESXA";
        const FRAGMENT_HASH = "6ade96165ad50e848f";
        const FRAGMENT_COOKIES = {
            "stel_token": "573989339c79da643f028d43fb7ce43f57398928573985ab4cec0a18cc62c05e8b56c",
            "stel_ssid": "aab4b2c0cdf9355c67_15750321694171883784",
            "stel_ton_token": "f2-seWaLqSsBVk4CTxvsVOtTkioMMHiBIhs5uu-Oj2j1h2xlTW0oSeAXbYUebsnmpbKou1Gq8-KH9Gx5DHlAXFirrCjGNFy-Z5lKEoHMk1vdF28l1NVWEMEOo2QMHG9hQib3nbJQGwNI4OzjGGY6ySzf7nRcou_qRXPg18Spn14D9DRRjHUSnShV7bcXwhuxoD4tcIFL"
        };
        const FRAGMENT_HEADERS = {
            "User-Agent": "Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Mobile Safari/537.36",
            "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
        };
        
        // Wallet address
        const WALLET_ADDRESS = "UQDNP3f2o8ouV6tm17QWpbowXcKNEmKoJ4im-cuIx1nN4snB";
        const DEFAULT_MARKUP = 20;
        
        // App state
        let currentMarkup = DEFAULT_MARKUP;
        let paymentData = {
            self: {},
            friend: {}
        };
        let paymentCheckIntervals = {
            self: null,
            friend: null
        };
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is admin
            if (tg.initDataUnsafe.user && tg.initDataUnsafe.user.id === 511301057) {
                document.getElementById('admin-btn').classList.remove('hidden');
            }
            
            // Set current markup from localStorage or default
            const savedMarkup = localStorage.getItem('markup_percent');
            if (savedMarkup) {
                currentMarkup = parseFloat(savedMarkup);
                document.getElementById('current-markup').textContent = `${currentMarkup}%`;
            }
        });
        
        // Navigation functions
        function showBuySection(type) {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            
            if (type === 'self') {
                document.getElementById('buy-self-section').classList.remove('hidden');
                document.getElementById('buy-friend-section').classList.add('hidden');
                
                // Auto-fill username if available
                if (tg.initDataUnsafe.user && tg.initDataUnsafe.user.username) {
                    document.getElementById('self-username').value = `@${tg.initDataUnsafe.user.username}`;
                }
            } else {
                document.getElementById('buy-self-section').classList.add('hidden');
                document.getElementById('buy-friend-section').classList.remove('hidden');
            }
        }
        
        function backToMain() {
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('buy-self-section').classList.add('hidden');
            document.getElementById('buy-friend-section').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            
            // Reset all forms
            resetForms();
            
            // Clear any payment check intervals
            clearPaymentCheckIntervals();
        }
        
        function showAdminPanel() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('buy-self-section').classList.add('hidden');
            document.getElementById('buy-friend-section').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            
            // Set current markup value
            document.getElementById('current-markup').textContent = `${currentMarkup}%`;
            document.getElementById('new-markup').value = '';
        }
        
        function resetForms() {
            // Reset self form
            document.getElementById('self-username').value = '';
            document.getElementById('self-stars-amount').value = '';
            document.getElementById('self-price-result').classList.add('hidden');
            document.getElementById('self-payment-section').classList.add('hidden');
            
            // Reset friend form
            document.getElementById('friend-username').value = '';
            document.getElementById('friend-stars-amount').value = '';
            document.getElementById('friend-price-result').classList.add('hidden');
            document.getElementById('friend-payment-section').classList.add('hidden');
            
            // Reset payment status displays
            document.getElementById('self-payment-waiting').classList.remove('hidden');
            document.getElementById('self-payment-success').classList.add('hidden');
            document.getElementById('self-payment-failed').classList.add('hidden');
            
            document.getElementById('friend-payment-waiting').classList.remove('hidden');
            document.getElementById('friend-payment-success').classList.add('hidden');
            document.getElementById('friend-payment-failed').classList.add('hidden');
        }
        
        function clearPaymentCheckIntervals() {
            if (paymentCheckIntervals.self) {
                clearInterval(paymentCheckIntervals.self);
                paymentCheckIntervals.self = null;
            }
            if (paymentCheckIntervals.friend) {
                clearInterval(paymentCheckIntervals.friend);
                paymentCheckIntervals.friend = null;
            }
        }
        
        // Insert self username
        function insertSelfUsername() {
            if (tg.initDataUnsafe.user && tg.initDataUnsafe.user.username) {
                document.getElementById('self-username').value = `@${tg.initDataUnsafe.user.username}`;
            } else {
                tg.showAlert('–£ –≤–∞—Å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Telegram username. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Telegram.');
            }
        }
        
        // Calculate price functions
        async function calculateSelfPrice() {
            const username = document.getElementById('self-username').value.trim();
            const starsAmount = parseInt(document.getElementById('self-stars-amount').value);
            
            if (!username || !username.startsWith('@')) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram username (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å @)');
                return;
            }
            
            if (isNaN(starsAmount) || starsAmount < 50 || starsAmount > 25000) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ –æ—Ç 50 –¥–æ 25,000');
                return;
            }
            
            try {
                // Get current TON price for stars from Fragment API
                const pricePerStar = await getFragmentPrice();
                
                // Calculate prices
                const basePrice = starsAmount * pricePerStar;
                const markupAmount = basePrice * (currentMarkup / 100);
                const totalPrice = basePrice + markupAmount;
                
                // Save payment data
                paymentData.self = {
                    username: username,
                    starsAmount: starsAmount,
                    basePrice: basePrice,
                    markupAmount: markupAmount,
                    totalPrice: totalPrice,
                    pricePerStar: pricePerStar
                };
                
                // Display results
                document.getElementById('self-recipient').textContent = username;
                document.getElementById('self-stars-count').textContent = `${starsAmount} ‚≠êÔ∏è`;
                document.getElementById('self-stars-price').textContent = `${basePrice.toFixed(3)} TON`;
                document.getElementById('self-markup').textContent = `${markupAmount.toFixed(3)} TON (${currentMarkup}%)`;
                document.getElementById('self-total-price').textContent = `${totalPrice.toFixed(3)} TON`;
                
                // Show results section
                document.getElementById('self-price-result').classList.remove('hidden');
            } catch (error) {
                console.error('Error getting price:', error);
                tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∑–≤—ë–∑–¥. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }
        
        async function calculateFriendPrice() {
            const username = document.getElementById('friend-username').value.trim();
            const starsAmount = parseInt(document.getElementById('friend-stars-amount').value);
            
            if (!username || !username.startsWith('@')) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram username (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å @)');
                return;
            }
            
            if (isNaN(starsAmount) || starsAmount < 50 || starsAmount > 25000) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ –æ—Ç 50 –¥–æ 25,000');
                return;
            }
            
            try {
                // Get current TON price for stars from Fragment API
                const pricePerStar = await getFragmentPrice();
                
                // Calculate prices
                const basePrice = starsAmount * pricePerStar;
                const markupAmount = basePrice * (currentMarkup / 100);
                const totalPrice = basePrice + markupAmount;
                
                // Save payment data
                paymentData.friend = {
                    username: username,
                    starsAmount: starsAmount,
                    basePrice: basePrice,
                    markupAmount: markupAmount,
                    totalPrice: totalPrice,
                    pricePerStar: pricePerStar
                };
                
                // Display results
                document.getElementById('friend-recipient').textContent = username;
                document.getElementById('friend-stars-count').textContent = `${starsAmount} ‚≠êÔ∏è`;
                document.getElementById('friend-stars-price').textContent = `${basePrice.toFixed(3)} TON`;
                document.getElementById('friend-markup').textContent = `${markupAmount.toFixed(3)} TON (${currentMarkup}%)`;
                document.getElementById('friend-total-price').textContent = `${totalPrice.toFixed(3)} TON`;
                
                // Show results section
                document.getElementById('friend-price-result').classList.remove('hidden');
            } catch (error) {
                console.error('Error getting price:', error);
                tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∑–≤—ë–∑–¥. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }
        
        // Get current price from Fragment API
        async function getFragmentPrice() {
            try {
                // In a real app, you would call the Fragment API here
                // For demo purposes, we'll use a fixed price
                // const response = await fetch('https://fragment.com/api', {
                //     method: 'POST',
                //     headers: FRAGMENT_HEADERS,
                //     body: new URLSearchParams({
                //         hash: FRAGMENT_HASH,
                //         stel_token: FRAGMENT_COOKIES.stel_token,
                //         stel_ssid: FRAGMENT_COOKIES.stel_ssid,
                //         stel_ton_token: FRAGMENT_COOKIES.stel_ton_token
                //     })
                // });
                // const data = await response.json();
                // return data.price_per_star;
                
                return 0.01; // Fixed price for demo (0.01 TON per star)
            } catch (error) {
                console.error('Error getting price from Fragment:', error);
                throw error;
            }
        }
        
        // Back navigation in forms
        function backToSelfForm() {
            document.getElementById('self-price-result').classList.add('hidden');
        }
        
        function backToFriendForm() {
            document.getElementById('friend-price-result').classList.add('hidden');
        }
        
        function backToSelfPrice() {
            document.getElementById('self-payment-section').classList.add('hidden');
            document.getElementById('self-price-result').classList.remove('hidden');
            
            // Clear payment check interval
            if (paymentCheckIntervals.self) {
                clearInterval(paymentCheckIntervals.self);
                paymentCheckIntervals.self = null;
            }
        }
        
        function backToFriendPrice() {
            document.getElementById('friend-payment-section').classList.add('hidden');
            document.getElementById('friend-price-result').classList.remove('hidden');
            
            // Clear payment check interval
            if (paymentCheckIntervals.friend) {
                clearInterval(paymentCheckIntervals.friend);
                paymentCheckIntervals.friend = null;
            }
        }
        
        // Payment functions
        function proceedToPayment(type) {
            const data = paymentData[type];
            
            // Generate memo (in real app this should be done on backend)
            const memo = generateMemo();
            
            // Save memo to payment data
            paymentData[type].memo = memo;
            
            // Create payment link
            const paymentLink = `https://app.tonkeeper.com/transfer/${WALLET_ADDRESS}?amount=${Math.round(data.totalPrice * 1000)}&text=${memo}`;
            
            // Update UI
            if (type === 'self') {
                document.getElementById('self-price-result').classList.add('hidden');
                document.getElementById('self-payment-section').classList.remove('hidden');
                
                document.getElementById('self-payment-amount').textContent = `${data.totalPrice.toFixed(3)} TON`;
                document.getElementById('self-payment-address').textContent = WALLET_ADDRESS;
                document.getElementById('self-payment-memo').textContent = memo;
                document.getElementById('self-tonkeeper-link').href = paymentLink;
                
                // Generate QR code
                generateQRCode('self-qr-code', paymentLink);
                
                // Show payment status
                document.getElementById('self-payment-waiting').classList.remove('hidden');
                document.getElementById('self-payment-success').classList.add('hidden');
                document.getElementById('self-payment-failed').classList.add('hidden');
                
                // Start checking payment status
                startPaymentCheck(type, memo, data.totalPrice);
            } else {
                document.getElementById('friend-price-result').classList.add('hidden');
                document.getElementById('friend-payment-section').classList.remove('hidden');
                
                document.getElementById('friend-payment-amount').textContent = `${data.totalPrice.toFixed(3)} TON`;
                document.getElementById('friend-payment-address').textContent = WALLET_ADDRESS;
                document.getElementById('friend-payment-memo').textContent = memo;
                document.getElementById('friend-tonkeeper-link').href = paymentLink;
                
                // Generate QR code
                generateQRCode('friend-qr-code', paymentLink);
                
                // Show payment status
                document.getElementById('friend-payment-waiting').classList.remove('hidden');
                document.getElementById('friend-payment-success').classList.add('hidden');
                document.getElementById('friend-payment-failed').classList.add('hidden');
                
                // Start checking payment status
                startPaymentCheck(type, memo, data.totalPrice);
            }
        }
        
        function startPaymentCheck(type, memo, amount) {
            // Clear any existing interval
            if (paymentCheckIntervals[type]) {
                clearInterval(paymentCheckIntervals[type]);
            }
            
            // Start checking payment status every 5 seconds
            paymentCheckIntervals[type] = setInterval(() => {
                checkPaymentStatus(type, memo, amount);
            }, 5000);
            
            // Initial check
            checkPaymentStatus(type, memo, amount);
        }
        
        async function checkPaymentStatus(type, memo, amount) {
            try {
                // In a real app, you would call your backend API to check if payment was received
                // For demo purposes, we'll simulate a successful payment after 15 seconds
                
                // Simulate checking with TON API
                // const response = await fetch(`https://tonapi.io/v1/account/getTransactions?account=${WALLET_ADDRESS}&limit=10`, {
                //     headers: {
                //         'Authorization': `Bearer ${TONAPI_KEY}`
                //     }
                // });
                // const transactions = await response.json();
                
                // Check if any transaction matches our memo and amount
                // const paymentReceived = transactions.some(tx => {
                //     return tx.comment === memo && 
                //            tx.value === amount && 
                //            tx.destination === WALLET_ADDRESS;
                // });
                
                // For demo, we'll simulate a successful payment after 15 seconds
                const paymentReceived = false;
                
                if (paymentReceived) {
                    // Payment confirmed
                    clearInterval(paymentCheckIntervals[type]);
                    paymentCheckIntervals[type] = null;
                    
                    if (type === 'self') {
                        document.getElementById('self-payment-waiting').classList.add('hidden');
                        document.getElementById('self-payment-success').classList.remove('hidden');
                    } else {
                        document.getElementById('friend-payment-waiting').classList.add('hidden');
                        document.getElementById('friend-payment-success').classList.remove('hidden');
                    }
                    
                    // In a real app, you would now process the stars purchase
                } else {
                    // After 15 seconds, simulate a successful payment for demo
                    if (Date.now() - paymentData[type].paymentStartTime > 15000) {
                        clearInterval(paymentCheckIntervals[type]);
                        paymentCheckIntervals[type] = null;
                        
                        if (type === 'self') {
                            document.getElementById('self-payment-waiting').classList.add('hidden');
                            document.getElementById('self-payment-success').classList.remove('hidden');
                        } else {
                            document.getElementById('friend-payment-waiting').classList.add('hidden');
                            document.getElementById('friend-payment-success').classList.remove('hidden');
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking payment status:', error);
                
                // After 3 failed checks, show payment failed
                paymentData[type].checkAttempts = (paymentData[type].checkAttempts || 0) + 1;
                
                if (paymentData[type].checkAttempts >= 3) {
                    clearInterval(paymentCheckIntervals[type]);
                    paymentCheckIntervals[type] = null;
                    
                    if (type === 'self') {
                        document.getElementById('self-payment-waiting').classList.add('hidden');
                        document.getElementById('self-payment-failed').classList.remove('hidden');
                    } else {
                        document.getElementById('friend-payment-waiting').classList.add('hidden');
                        document.getElementById('friend-payment-failed').classList.remove('hidden');
                    }
                }
            }
        }
        
        function copyPaymentDetails(type) {
            const data = paymentData[type];
            const memo = data.memo;
            const text = `–ê–¥—Ä–µ—Å: ${WALLET_ADDRESS}\n–°—É–º–º–∞: ${data.totalPrice.toFixed(3)} TON\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${memo}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                tg.showAlert('–†–µ–∫–≤–∏–∑–∏—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            }).catch(err => {
                tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã');
                console.error('Failed to copy: ', err);
            });
        }
        
        // Admin functions
        function updateMarkup() {
            const newMarkup = parseFloat(document.getElementById('new-markup').value);
            
            if (isNaN(newMarkup) || newMarkup < 0 || newMarkup > 100) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç (–æ—Ç 0 –¥–æ 100)');
                return;
            }
            
            // Save to localStorage (in real app you would save to backend)
            localStorage.setItem('markup_percent', newMarkup.toString());
            currentMarkup = newMarkup;
            
            // Update UI
            document.getElementById('current-markup').textContent = `${newMarkup}%`;
            document.getElementById('new-markup').value = '';
            
            // Show success message
            const messageDiv = document.getElementById('admin-message');
            messageDiv.textContent = `–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—Ü–µ–Ω–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ ${newMarkup}%`;
            messageDiv.classList.remove('hidden');
            messageDiv.classList.add('bg-green-500/10', 'text-green-500');
            
            // Hide message after 3 seconds
            setTimeout(() => {
                messageDiv.classList.add('hidden');
                messageDiv.classList.remove('bg-green-500/10', 'text-green-500');
            }, 3000);
        }
        
        // Helper functions
        function generateMemo() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function generateQRCode(canvasId, text) {
            QRCode.toCanvas(document.getElementById(canvasId), text, {
                width: 180,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            }, function(error) {
                if (error) console.error(error);
            });
        }
    </script>
</body>
</html>
