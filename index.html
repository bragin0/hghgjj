<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarsBot - –ö—É–ø–∏—Ç—å Telegram Stars</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6D28D9',
                        secondary: '#8B5CF6',
                        dark: '#1E1B4B',
                        light: '#F5F3FF',
                        accent: '#A78BFA'
                    }
                }
            }
        }
    </script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
        font-family: 'Inter', sans-serif;
        min-height: 100vh;
        position: relative;
    }
    body.stars-bg {
        background: #1E1B4B;
        background: linear-gradient(135deg, #1E1B4B 0%, #4C1D95 100%), 
                    url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 0c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zM11 78c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 0c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zM11 48c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 0c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z' fill='%238B5CF6' fill-opacity='0.05' fill-rule='evenodd'/%3E%3Ccircle cx='50' cy='50' r='5' fill='%23FFFFFF' fill-opacity='0.1'/%3E%3Ccircle cx='20' cy='20' r='5' fill='%23FFFFFF' fill-opacity='0.1'/%3E%3Ccircle cx='80' cy='30' r='4' fill='%23FFFFFF' fill-opacity='0.15'/%3E%3Ccircle cx='30' cy='70' r='6' fill='%23FFFFFF' fill-opacity='0.1'/%3E%3Ccircle cx='70' cy='60' r='3' fill='%23FFFFFF' fill-opacity='0.12'/%3E%3C/svg%3E");
        background-attachment: fixed;
        background-size: cover, 100px 100px;
        background-repeat: no-repeat, repeat;
    }
    .message-container {
        height: calc(100vh - 400px);
        scroll-behavior: smooth;
    }
    .chat-bubble {
        animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .typing-indicator {
        display: inline-flex;
        align-items: center;
    }
    .typing-dot {
        width: 8px;
        height: 8px;
        background-color: #8B5CF6;
        border-radius: 50%;
        margin: 0 3px;
        animation: pulse 1.5s infinite;
    }
    .typing-dot:nth-child(2) {
        animation-delay: 0.5s;
    }
    .typing-dot:nth-child(3) {
        animation-delay: 1s;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
    }
    .wave {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        overflow: hidden;
        line-height: 0;
        transform: rotate(180deg);
        z-index: 0;
    }
    .wave svg {
        position: relative;
        display: block;
        width: calc(100% + 1.3px);
        height: 73px;
    }
    .wave .shape-fill {
        fill: #1E1B4B;
    }
    .wave path:nth-child(1) {
        animation: wave1 10s linear infinite;
    }
    .wave path:nth-child(2) {
        animation: wave2 8s linear infinite;
    }
    .wave path:nth-child(3) {
        animation: wave3 6s linear infinite;
    }
    @keyframes wave1 {
        0% { transform: translateX(0); }
        50% { transform: translateX(-100px); }
        100% { transform: translateX(0); }
    }
    @keyframes wave2 {
        0% { transform: translateX(0); }
        50% { transform: translateX(80px); }
        100% { transform: translateX(0); }
    }
    @keyframes wave3 {
        0% { transform: translateX(0); }
        50% { transform: translateX(-120px); }
        100% { transform: translateX(0); }
    }
    .chat-bubble .qr-code {
        width: 250px !important;
        height: 250px !important;
        border: 8px solid white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin: 0 auto;
    }
    .chat-bubble code {
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        word-break: break-all;
    }
    .chat-bubble button {
        padding: 6px 12px;
        background: none;
        border: none;
        cursor: pointer;
        transition: color 0.3s;
    }
    .chat-bubble button:hover {
        color: #A78BFA;
    }
</style>
</head>
<body class="stars-bg">
    <!-- Wave divider -->
    <div class="wave">
        <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" opacity=".25" class="shape-fill"></path>
            <path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" opacity=".5" class="shape-fill"></path>
            <path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" class="shape-fill"></path>
        </svg>
    </div>
    
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="py-6 px-4 sm:px-6 backdrop-blur-sm bg-dark/80 border-b border-accent/30">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center">
                        <i class="fas fa-star text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">StarsBot</h1>
                        <p class="text-xs text-light/60">–ö—É–ø–∏—Ç—å Telegram Stars</p>
                    </div>
                </div>
                <div id="userProfile" class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gray-500 flex items-center justify-center overflow-hidden">
                        <img id="userAvatar" src="" alt="User Avatar" class="w-full h-full object-cover hidden">
                        <i id="userAvatarPlaceholder" class="fas fa-user text-white text-lg"></i>
                    </div>
                    <span id="username" class="text-white font-medium"></span>
                </div>
            </div>
        </header>
        
        <!-- Chat container -->
        <main class="flex-1 py-6 px-4 sm:px-6">
            <div class="max-w-3xl mx-auto">
                <div id="messages" class="message-container space-y-4 overflow-y-auto mb-6">
                    <!-- Welcome message -->
                    <div class="chat-bubble bg-gradient-to-r from-dark to-dark/90 p-5 rounded-2xl rounded-tl-none shadow-lg">
                        <div class="text-white">
                            <div class="font-bold text-lg flex items-center">
                                <div class="w-6 h-6 rounded-full bg-primary flex items-center justify-center mr-2">
                                    <i class="fas fa-robot text-xs"></i>
                                </div>
                                StarsBot
                            </div>
                            <div class="mt-3 space-y-3">
                                <p>üëã <span class="font-bold">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ StarsBot!</span></p>
                                <p>–Ø –ø–æ–º–æ–≥—É –≤–∞–º –∫—É–ø–∏—Ç—å <span class="font-bold">Telegram Stars</span> –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ!</p>
                                <div class="bg-dark/50 p-3 rounded-lg">
                                    <p class="text-sm">
                                        <span class="text-accent">üîπ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞:</span> 50 –∑–≤—ë–∑–¥<br>
                                        <span class="text-accent">üîπ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞:</span> 25000 –∑–≤—ë–∑–¥
                                    </p>
                                </div>
                                <p class="pt-2">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–º—É —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã:</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Buttons -->
                <div id="actionButtons" class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="selectOption('buy_self')" class="option-btn bg-gradient-to-r from-primary to-primary/90 hover:from-primary/80 hover:to-primary/70 text-white py-4 px-4 rounded-xl flex flex-col items-center justify-center transition transform hover:scale-[1.02] shadow-lg">
                        <div class="w-12 h-12 rounded-full bg-light/10 flex items-center justify-center mb-2">
                            <i class="fas fa-user text-2xl"></i>
                        </div>
                        <span class="font-medium">–ö—É–ø–∏—Ç—å —Å–µ–±–µ</span>
                    </button>
                    <button onclick="selectOption('buy_friend')" class="option-btn bg-gradient-to-r from-secondary to-secondary/90 hover:from-secondary/80 hover:to-secondary/70 text-white py-4 px-4 rounded-xl flex flex-col items-center justify-center transition transform hover:scale-[1.02] shadow-lg">
                        <div class="w-12 h-12 rounded-full bg-light/10 flex items-center justify-center mb-2">
                            <i class="fas fa-gift text-2xl"></i>
                        </div>
                        <span class="font-medium">–ö—É–ø–∏—Ç—å –¥—Ä—É–≥—É</span>
                    </button>
                </div>
                
                <!-- Input area -->
                <div class="bg-dark/60 border border-accent/30 rounded-xl p-4 backdrop-blur-sm">
                    <div id="inputArea">
                        
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // State management
        const state = {
            current: 'start',
            recipientType: '', // self or friend
            quantity: 0,
            recipient: '',
            memo: '',
            amount: 0,
            isAdmin: false,
            markupPercent: 20.0,
            user: {
                id: null,
                username: '',
                photoUrl: ''
            }
        };

        // Telegram Web App initialization
        window.addEventListener('load', function() {
        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            const user = Telegram.WebApp.initDataUnsafe.user;
            if (user) {
                state.user.id = user.id;
                state.user.username = user.username || '';
                state.user.photoUrl = user.photo_url || '';
                
                // Update header with user info
                document.getElementById('username').textContent = state.user.username ? `@${state.user.username}` : '–ê–Ω–æ–Ω–∏–º';
                if (state.user.photoUrl) {
                    const avatar = document.getElementById('userAvatar');
                    avatar.src = state.user.photoUrl;
                    avatar.classList.remove('hidden');
                    document.getElementById('userAvatarPlaceholder').classList.add('hidden');
                }
                
                // Store username
                localStorage.setItem('tg_username', state.user.username);
            }
            }
            
            const messagesContainer = document.getElementById('messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        // Generate random memo
        function generateMemo() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let memo = '';
            for (let i = 0; i < 8; i++) {
                memo += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return memo;
        }

        // Display typing indicator
        function showTyping() {
            const messagesContainer = document.getElementById('messages');
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('chat-bubble', 'bg-dark/60', 'p-4', 'rounded-2xl', 'rounded-tl-none', 'shadow');
            typingIndicator.innerHTML = `
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded-full bg-primary flex items-center justify-center mr-3">
                        <i class="fas fa-robot text-xs text-white"></i>
                    </div>
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return typingIndicator;
        }

        // Hide typing indicator
        function hideTyping(typingElement) {
            typingElement.remove();
        }

        // Add a message to the chat
        function addMessage(text, isUser = false) {
            const messagesContainer = document.getElementById('messages');
            const typingElement = showTyping();
            
            setTimeout(() => {
                hideTyping(typingElement);
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-bubble');
                
                if (isUser) {
                    messageDiv.classList.add('ml-10', 'bg-dark/40', 'border', 'border-accent/20', 'rounded-2xl', 'rounded-tr-none');
                    messageDiv.innerHTML = `
                        <div class="text-white flex items-start">
                            <div class="w-8 h-8 rounded-full bg-secondary flex items-center justify-center mr-3">
                                <i class="fas fa-user text-sm"></i>
                            </div>
                            <div class="pt-1">${text}</div>
                        </div>
                    `;
                } else {
                    messageDiv.classList.add('bg-gradient-to-r', 'from-dark', 'to-dark/90', 'p-5', 'rounded-2xl', 'rounded-tl-none', 'shadow-lg');
                    messageDiv.innerHTML = `
                        <div class="text-white">
                            <div class="font-bold text-lg flex items-center">
                                <div class="w-6 h-6 rounded-full bg-primary flex items-center justify-center mr-2">
                                    <i class="fas fa-robot text-xs"></i>
                                </div>
                                StarsBot
                            </div>
                            <div class="mt-3">${text}</div>
                        </div>
                    `;
                }
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1000);
        }

        // Generate QR code
        function generateQRCode(text, elementId) {
            console.log('Generating QR code for:', text, 'Element ID:', elementId);
            const qrElement = document.getElementById(elementId);
            if (qrElement) {
                qrElement.innerHTML = '';
                QRCode.toCanvas(qrElement, text, {
                    width: 250,
                    height: 250,
                    margin: 0,
                    color: {
                        dark: '#1E1B4B',
                        light: '#FFFFFF'
                    }
                }, function(error) {
                    if (error) {
                        console.error('QR Code generation error:', error);
                        addMessage('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    } else {
                        console.log('QR Code generated successfully');
                    }
                });
            } else {
                console.error('QR Code element not found:', elementId);
                addMessage('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è QR-–∫–æ–¥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        }

        // Calculate stars price
        function calculatePrice(quantity) {
            const basePrice = quantity / 100;
            const markup = basePrice * (state.markupPercent / 100);
            return (basePrice + markup).toFixed(3);
        }

        // Handle command input
        function submitCommand() {
            const commandInput = document.getElementById('commandInput');
            const command = commandInput.value.trim();
            addMessage(command, true);
            
            if (command.toLowerCase() === '/admin') {
                selectOption('admin_menu');
            } else {
                addMessage('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /admin');
            }
            
            commandInput.value = '';
        }

        // Handle option selection
        function selectOption(option) {
            if (option === 'buy_self' || option === 'buy_friend') {
                state.recipientType = option;
                state.current = 'quantity';
                addMessage(option === 'buy_self' 
                    ? "üåü –ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã —Å–µ–±–µ<br><br>–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ (–æ—Ç 50 –¥–æ 25000):" 
                    : "üéÅ –ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã –¥—Ä—É–≥—É<br><br>–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ (–æ—Ç 50 –¥–æ 25000):");
                
                // –û—á–∏—â–∞–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('actionButtons').innerHTML = '';
                
                document.getElementById('inputArea').innerHTML = `
                    <div class="flex">
                        <input type="number" id="quantityInput" min="50" max="25000" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" class="flex-1 bg-dark/40 border border-accent/30 text-white rounded-l-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-accent/50">
                        <button onclick="submitQuantity()" class="bg-primary hover:bg-primary/90 text-white px-5 rounded-r-xl transition">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                `;
            } else if (option === 'admin_menu') {
                state.isAdmin = true;
                state.current = 'admin_menu';
                addMessage(`üë®‚Äçüíº –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å<br><br>–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—Ü–µ–Ω–∫–∏: <strong>${state.markupPercent}%</strong><br>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`);
                
                document.getElementById('actionButtons').innerHTML = `
                    <button onclick="selectOption('change_markup')" class="bg-gradient-to-r from-primary to-primary/90 hover:from-primary/80 hover:to-primary/70 text-white py-4 px-4 rounded-xl flex flex-col items-center justify-center transition transform hover:scale-[1.02] shadow-lg">
                        <div class="w-12 h-12 rounded-full bg-light/10 flex items-center justify-center mb-2">
                            <i class="fas fa-percent text-2xl"></i>
                        </div>
                        <span class="font-medium">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É</span>
                    </button>
                `;
            } else if (option === 'change_markup') {
                state.current = 'markup_percent';
                addMessage(`üìà –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –Ω–∞—Ü–µ–Ω–∫–∏<br><br>–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç: <strong>${state.markupPercent}%</strong><br>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: <code>30</code> –¥–ª—è 30%):`);
                
                document.getElementById('inputArea').innerHTML = `
                    <div class="flex">
                        <input type="number" id="percentInput" min="0" step="1" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç" class="flex-1 bg-dark/40 border border-accent/30 text-white rounded-l-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-accent/50">
                        <button onclick="submitMarkupPercent()" class="bg-primary hover:bg-primary/90 text-white px-5 rounded-r-xl transition">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                `;
            }
        }

        // Submit quantity
        function submitQuantity() {
            const quantityInput = document.getElementById('quantityInput');
            const quantity = parseInt(quantityInput.value);
            
            if (isNaN(quantity) || quantity < 50 || quantity > 25000) {
                addMessage('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 50 –¥–æ 25000');
                return;
            }
            
            state.quantity = quantity;
            
            if (state.recipientType === 'buy_self') {
                if (!state.user.username) {
                    state.current = 'self_username';
                    addMessage('üë§ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram username –≤ —Ñ–æ—Ä–º–∞—Ç–µ <code>@username</code> (username –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Ü–∏—Ñ—Ä—ã):');
                    
                    document.getElementById('inputArea').innerHTML = `
                        <div class="flex">
                            <input type="text" id="usernameInput" placeholder="@username" class="flex-1 bg-dark/40 border border-accent/30 text-white rounded-l-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-accent/50">
                            <button onclick="submitUsername()" class="bg-primary hover:bg-primary/90 text-white px-5 rounded-r-xl transition">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    `;
                } else {
                    state.recipient = `@${state.user.username}`;
                    preparePayment();
                }
            } else {
                state.current = 'friend_username';
                addMessage('üë§ –í–≤–µ–¥–∏—Ç–µ Telegram username –¥—Ä—É–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ <code>@username</code> (username –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Ü–∏—Ñ—Ä—ã):');
                
                document.getElementById('inputArea').innerHTML = `
                    <div class="flex">
                        <input type="text" id="usernameInput" placeholder="@username" class="flex-1 bg-dark/40 border border-accent/30 text-white rounded-l-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-accent/50">
                        <button onclick="submitUsername()" class="bg-primary hover:bg-primary/90 text-white px-5 rounded-r-xl transition">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                `;
            }
        }

        // Submit friend or self username
        function submitUsername() {
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            
            if (!username.startsWith('@')) {
                addMessage('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ username –≤ —Ñ–æ—Ä–º–∞—Ç–µ <code>@username</code>');
                return;
            }
            
            const usernameWithoutAt = username.substring(1);
            if (!usernameWithoutAt || /^\d/.test(usernameWithoutAt)) {
                addMessage('‚ö†Ô∏è Username –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Ü–∏—Ñ—Ä—ã –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            
            state.recipient = username;
            if (state.recipientType === 'buy_self') {
                state.user.username = usernameWithoutAt;
                localStorage.setItem('tg_username', usernameWithoutAt);
                document.getElementById('username').textContent = `@${state.user.username}`;
            }
            preparePayment();
        }

        // Prepare payment
        function preparePayment() {
            state.current = 'payment';
            state.memo = generateMemo();
            state.amount = calculatePrice(state.quantity);
            
            console.log('Preparing payment:', { quantity: state.quantity, recipient: state.recipient, amount: state.amount, memo: state.memo });
            
            const paymentText = `
                ${state.recipientType === 'buy_self' ? 'üåü –ü–æ–∫—É–ø–∫–∞ –∑–≤—ë–∑–¥ –¥–ª—è —Å–µ–±—è' : 'üéÅ –ü–æ–¥–∞—Ä–æ–∫ –¥–ª—è –¥—Ä—É–≥–∞!'}<br><br>
                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥: <strong>${state.quantity} ‚≠êÔ∏è</strong><br>
                –ü–æ–ª—É—á–∞—Ç–µ–ª—å: <strong>${state.recipient}</strong><br>
                –°—É–º–º–∞: <strong>${state.amount} TON</strong><br><br>
            `;
            
            addMessage(paymentText);
            
            document.getElementById('inputArea').innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="resetToStart()" class="w-full bg-dark/40 hover:bg-dark/80 border border-accent/30 text-white font-medium py-3 px-4 rounded-xl flex items-center justify-center transition">
                        <i class="fas fa-undo mr-2"></i> –ù–∞–∑–∞–¥
                    </button>
                    <button onclick="showPaymentDetails()" class="w-full bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white font-medium py-3 px-4 rounded-xl flex items-center justify-center transition transform hover:scale-[1.02]">
                        <i class="fas fa-wallet mr-2"></i> –û–ø–ª–∞—Ç–∏—Ç—å
                    </button>
                </div>
            `;
        }

        // Show payment details in chat
        function showPaymentDetails() {
            const paymentAmount = state.amount;
            const paymentMemo = state.memo;
            const walletAddress = "UQDNP3f2o8ouV6tm17QWpbowXcKNEmKoJ4im-cuIx1nN4snB";
            const paymentLink = `https://app.tonkeeper.com/transfer/${walletAddress}?amount=${parseInt(parseFloat(paymentAmount)*1000000000)}&text=${paymentMemo}`;
            
            console.log('Payment details:', { paymentAmount, paymentMemo, walletAddress, paymentLink });
            
            const title = state.recipientType === 'buy_self' 
                ? 'üõí –ü–æ–∫—É–ø–∫–∞ –∑–≤—ë–∑–¥ –¥–ª—è —Å–µ–±—è' 
                : 'üéÅ –ü–æ–¥–∞—Ä–æ–∫ –¥–ª—è –¥—Ä—É–≥–∞!';
            
            // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è QR-–∫–æ–¥–∞
            const qrCodeId = `qrCode_${Date.now()}`;
            
            const paymentDetails = `
                ${title}<br><br>
                üîπ <strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> <code>${state.recipient}</code><br>
                üîπ <strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥:</strong> ${state.quantity} ‚≠êÔ∏è<br>
                üîπ <strong>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</strong> 10 –º–∏–Ω—É—Ç ‚è≥<br><br>
                üí≥ <strong>–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã:</strong><br><br>
                –°–µ—Ç—å: TON<br>
                –°—É–º–º–∞: <code>${paymentAmount}</code> TON<br>
                –ê–¥—Ä–µ—Å: <code id="walletAddress">${walletAddress}</code><br>
                <button class="text-accent text-sm mt-2 inline-block" onclick="copyToClipboard('walletAddress')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å</button><br><br>
                –î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç (memo) –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: <code id="paymentMemo">${paymentMemo}</code><br>
                <button class="text-accent text-sm mt-2 inline-block" onclick="copyToClipboard('paymentMemo')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å memo</button><br><br>
                ‚ö†Ô∏è <strong>${state.recipientType === 'buy_self' ? '–í–Ω–∏–º–∞–Ω–∏–µ!' : '–í–∞–∂–Ω–æ!'}</strong><br>
                1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ <strong>—Ç–æ—á–Ω—É—é</strong> —Å—É–º–º—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å.<br>
                2. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ, –∏–Ω–∞—á–µ –ø–ª–∞—Ç–µ–∂ –ù–ï –ó–ê–°–ß–ò–¢–ê–ï–¢–°–Ø.<br>
                3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.<br><br>
                üë∑‚Äç‚ôÇÔ∏è –í —Å–ª—É—á–∞–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.<br><br>
                <div class="flex justify-center mb-4">
                    <canvas id="${qrCodeId}" class="qr-code"></canvas>
                </div>
                <a href="${paymentLink}" class="block bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white font-medium py-3 px-4 rounded-xl text-center transition transform hover:scale-[1.02] mt-4">
                    <i class="fas fa-wallet mr-2"></i>–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Tonkeeper
                </a>
            `;
            
            addMessage(paymentDetails);
            
            // –£–≤–µ–ª–∏—á–∏–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ DOM
            setTimeout(() => {
                const qrElement = document.getElementById(qrCodeId);
                if (qrElement) {
                    generateQRCode(paymentLink, qrCodeId);
                } else {
                    console.error('QR Code element not found:', qrCodeId);
                    addMessage('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è QR-–∫–æ–¥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                }
            }, 2000); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 2000 –º—Å
        }

        // Submit markup percent
        function submitMarkupPercent() {
            const percentInput = document.getElementById('percentInput');
            const newPercent = parseFloat(percentInput.value);
            
            if (isNaN(newPercent) || newPercent < 0) {
                addMessage('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ');
                return;
            }
            
            state.markupPercent = newPercent;
            addMessage(`‚úÖ –ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—Ü–µ–Ω–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ <strong>${newPercent}%</strong>`);
            
            document.getElementById('inputArea').innerHTML = `
                <div class="flex">
                    <input type="text" id="commandInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: /admin)" class="flex-1 bg-dark/40 border border-accent/30 text-white rounded-l-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-accent/50">
                    <button onclick="submitCommand()" class="bg-primary hover:bg-primary/90 text-white px-5 rounded-r-xl transition">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `;
            
            // Show admin menu again
            document.getElementById('actionButtons').innerHTML = `
                <button onclick="selectOption('change_markup')" class="bg-gradient-to-r from-primary to-primary/90 hover:from-primary/80 hover:to-primary/70 text-white py-4 px-4 rounded-xl flex flex-col items-center justify-center transition transform hover:scale-[1.02] shadow-lg">
                    <div class="w-12 h-12 rounded-full bg-light/10 flex items-center justify-center mb-2">
                        <i class="fas fa-percent text-2xl"></i>
                    </div>
                    <span class="font-medium">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É</span>
                </button>
            `;
        }

        // Copy to clipboard
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text)
                .then(() => {
                    const originalText = document.querySelector(`#${elementId} + button`).innerText;
                    document.querySelector(`#${elementId} + button`).innerText = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    setTimeout(() => {
                        document.querySelector(`#${elementId} + button`).innerText = originalText;
                    }, 2000);
                });
        }

        // Reset to start
        function resetToStart() {
            state.current = 'start';
            state.recipientType = '';
            state.quantity = 0;
            state.recipient = '';
            
            document.getElementById('actionButtons').innerHTML = `
                <button onclick="selectOption('buy_self')" class="option-btn bg-gradient-to-r from-primary to-primary/90 hover:from-primary/80 hover:to-primary/70 text-white py-4 px-4 rounded-xl flex flex-col items-center justify-center transition transform hover:scale-[1.02] shadow-lg">
                    <div class="w-12 h-12 rounded-full bg-light/10 flex items-center justify-center mb-2">
                        <i class="fas fa-user text-2xl"></i>
                    </div>
                    <span class="font-medium">–ö—É–ø–∏—Ç—å —Å–µ–±–µ</span>
                </button>
                <button onclick="selectOption('buy_friend')" class="option-btn bg-gradient-to-r from-secondary to-secondary/90 hover:from-secondary/80 hover:to-secondary/70 text-white py-4 px-4 rounded-xl flex flex-col items-center justify-center transition transform hover:scale-[1.02] shadow-lg">
                    <div class="w-12 h-12 rounded-full bg-light/10 flex items-center justify-center mb-2">
                        <i class="fas fa-gift text-2xl"></i>
                    </div>
                    <span class="font-medium">–ö—É–ø–∏—Ç—å –¥—Ä—É–≥—É</span>
                </button>
            `;
            
            document.getElementById('inputArea').innerHTML = `
                <div class="flex">
                    <input type="text" id="commandInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: /admin)" class="flex-1 bg-dark/40 border border-accent/30 text-white rounded-l-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-accent/50">
                    <button onclick="submitCommand()" class="bg-primary hover:bg-primary/90 text-white px-5 rounded-r-xl transition">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>
