<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium VPN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #121212; color: #fff; margin: 0; padding: 16px; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { text-align: center; color: #00aaff; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 16px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .btn { background: #00aaff; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-size: 16px; margin: 8px 0; cursor: pointer; }
        .btn:disabled { background: #444; }
        .sub-list { margin: 16px 0; }
        .sub-item { background: #252525; border-radius: 8px; padding: 12px; margin: 8px 0; }
        .sub-id { font-family: monospace; background: #333; padding: 4px 8px; border-radius: 4px; word-break: break-all; }
        .loading { text-align: center; padding: 32px; }
        .error { color: #ff4444; text-align: center; }
        .platform-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .platform-btn { background: #333; padding: 12px; text-align: center; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Premium VPN</h1>
        <div id="content">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const API_BASE = "https://708b8c73cef3.ngrok-free.app/api"; // ‚Üê‚Üê‚Üê –ó–ê–ú–ï–ù–ò –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω/URL —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞

        let userId = null;

        async function auth() {
            const initData = tg.initData;
            if (!initData) return false;
            try {
                const resp = await fetch(`${API_BASE}/auth`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ initData })
                });
                const data = await resp.json();
                if (data.success) {
                    userId = data.user_id;
                    return true;
                }
            } catch (e) {}
            document.getElementById("content").innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>`;
            return false;
        }

        async function loadSubscriptions() {
            try {
                const resp = await fetch(`${API_BASE}/subscriptions?user_id=${userId}`);
                const data = await resp.json();
                if (!data.success) throw new Error();

                let html = `<button class="btn" onclick="showCreateForm()">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É</button><div class="sub-list">`;
                if (data.subscriptions.length === 0) {
                    html += `<div class="card">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</div>`;
                } else {
                    data.subscriptions.forEach(sub => {
                        const remaining = sub.remaining || "–ò—Å—Ç–µ–∫–ª–∞";
                        const status = sub.active ? "üü¢ –ê–∫—Ç–∏–≤–Ω–∞" : "üî¥ –ò—Å—Ç–µ–∫–ª–∞";
                        html += `
                        <div class="sub-item">
                            <b>${sub.name || "–ü–æ–¥–ø–∏—Å–∫–∞"} ${status}</b><br>
                            ID: <span class="sub-id">${sub.id}</span><br>
                            –ò—Å—Ç–µ–∫–∞–µ—Ç: ${sub.expires_at}<br>
                            –û—Å—Ç–∞–ª–æ—Å—å: <b>${remaining}</b><br>
                            –¢—Ä–∞—Ñ–∏–∫: ${(sub.up + sub.down) / (1024**3)}.toFixed(2) –ì–ë<br>
                            <button class="btn" style="margin-top:8px;" onclick="copyLink('${sub.link}')">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                            <div class="platform-btns">
                                <div class="platform-btn" onclick="alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É')">üì± Android</div>
                                <div class="platform-btn" onclick="alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É')">üçè iOS</div>
                                <div class="platform-btn" onclick="alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É')">üíª Windows</div>
                                <div class="platform-btn" onclick="alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É')">üçé macOS</div>
                            </div>
                        </div>`;
                    });
                }
                html += `</div>`;
                document.getElementById("content").innerHTML = html;
            } catch (e) {
                document.getElementById("content").innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫</div>`;
            }
        }

        function copyLink(link) {
            navigator.clipboard.writeText(link);
            tg.showPopup({message: "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä!"});
        }

        function showCreateForm() {
            const durations = [1,7,30,90,180,365];
            let html = `<div class="card"><h3>–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</h3>`;
            durations.forEach(d => {
                html += `<button class="btn" onclick="createSub(${d})">${d === 1 ? '1 –¥–µ–Ω—å' : d + ' –¥–Ω–µ–π'}</button>`;
            });
            html += `</div>`;
            document.getElementById("content").insertAdjacentHTML('afterbegin', html);
        }

        async function createSub(days) {
            tg.MainButton.setText("–°–æ–∑–¥–∞—ë–º...").show().disable();
            try {
                const resp = await fetch(`${API_BASE}/create`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, days })
                });
                const data = await resp.json();
                if (data.success) {
                    loadSubscriptions();
                    tg.showPopup({message: "–ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!"});
                } else {
                    tg.showPopup({message: data.error || "–û—à–∏–±–∫–∞"});
                }
            } catch (e) {
                tg.showPopup({message: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"});
            } finally {
                tg.MainButton.hide();
            }
        }

        (async () => {
            if (await auth()) await loadSubscriptions();
        })();
    </script>
</body>
</html>
