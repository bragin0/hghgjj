<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium VPN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .btn-tg { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-4">üöÄ Premium VPN</h2>
        <div id="profile" class="card mb-4 d-none">
            <div class="card-body">
                <h5>–ü—Ä–∏–≤–µ—Ç, <span id="username"></span>!</h5>
                <p>ID: <code id="user_id"></code></p>
                <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫: <span id="active_count">0</span>/3</p>
            </div>
        </div>

        <div id="subs-list"></div>

        <div class="text-center mt-4">
            <button class="btn btn-primary btn-tg me-2" id="create-btn" style="display:none;">‚ûï –ù–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</button>
            <button class="btn btn-secondary" onclick="Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–ø—Ä–æ–¥–ª–µ–Ω–∏—è -->
        <div class="modal fade" id="durationModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content bg-tg">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫</h5>
                    </div>
                    <div class="modal-body">
                        <div class="btn-group-vertical w-100">
                            <button class="btn btn-outline-primary" data-days="1">1 –¥–µ–Ω—å</button>
                            <button class="btn btn-outline-primary" data-days="7">7 –¥–Ω–µ–π</button>
                            <button class="btn btn-outline-primary" data-days="30">30 –¥–Ω–µ–π</button>
                            <button class="btn btn-outline-primary" data-days="90">90 –¥–Ω–µ–π</button>
                            <button class="btn btn-outline-primary" data-days="180">180 –¥–Ω–µ–π</button>
                            <button class="btn btn-outline-primary" data-days="365">365 –¥–Ω–µ–π</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const api = (endpoint, data = {}) => fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({init_data: tg.initData, ...data})
        }).then(r => r.json());

        let subscriptions = [];
        let selectedSubId = null;

        async function loadData() {
            const me = await api('/api/me');
            if (me.error) return alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            document.getElementById('username').textContent = me.first_name || me.username || '–î—Ä—É–≥';
            document.getElementById('user_id').textContent = me.id;
            document.getElementById('profile').classList.remove('d-none');

            const data = await api('/api/subscriptions');
            if (data.error) return alert(data.error);

            document.getElementById('active_count').textContent = data.active_count;
            if (data.active_count < 3) document.getElementById('create-btn').style.display = 'inline-block';

            subscriptions = data.subscriptions;
            renderSubs();
        }

        function renderSubs() {
            const container = document.getElementById('subs-list');
            container.innerHTML = '';
            if (subscriptions.length === 0) {
                container.innerHTML = '<p class="text-center">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫ üòî</p>';
                return;
            }
            subscriptions.forEach(sub => {
                const remaining = sub.expiry_ms ? Math.max(0, Math.ceil((sub.expiry_ms - Date.now()) / 86400000)) + ' –¥–Ω.' : '–ò—Å—Ç–µ–∫–ª–∞';
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <h5>${sub.name} ${sub.active ? 'üü¢' : 'üî¥'}</h5>
                        <p>ID: <code>${sub.id}</code></p>
                        <p>–¢—Ä–∞—Ñ–∏–∫: ${sub.traffic_gb} –ì–ë</p>
                        <p>–û—Å—Ç–∞–ª–æ—Å—å: <strong>${remaining}</strong></p>
                        <p>–°—Å—ã–ª–∫–∞:<br><code>${sub.link}</code></p>
                        ${sub.active ? `<button class="btn btn-sm btn-outline-primary extend-btn" data-sub="${sub.id}">–ü—Ä–æ–¥–ª–∏—Ç—å</button>` : ''}
                    </div>`;
                container.appendChild(card);
            });

            document.querySelectorAll('.extend-btn').forEach(btn => {
                btn.onclick = () => {
                    selectedSubId = btn.dataset.sub;
                    document.getElementById('modalTitle').textContent = '–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
                    new bootstrap.Modal('#durationModal').show();
                };
            });
        }

        document.getElementById('create-btn').onclick = () => {
            selectedSubId = null;
            document.getElementById('modalTitle').textContent = '–ù–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞';
            new bootstrap.Modal('#durationModal').show();
        };

        document.querySelectorAll('[data-days]').forEach(btn => {
            btn.onclick = async () => {
                const days = parseInt(btn.dataset.days);
                const endpoint = selectedSubId ? '/api/extend' : '/api/create';
                const body = selectedSubId ? {sub_id: selectedSubId, days} : {days};
                const res = await api(endpoint, body);
                if (res.error) alert(res.error);
                else {
                    alert(selectedSubId ? '–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞!' : '–ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                    loadData();
                }
                bootstrap.Modal.getInstance('#durationModal').hide();
            };
        });

        loadData();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>